---
title: "Aquaculture and EEZ's"
author: 'Peter Vitale'
date: '11/10/25'
format: html
editor: visual
execute: 
  cache: true
  warning: false
  message: false
---

In this project we will :

-   

-   

-   

-   

I'm going to start by loading in the necessary packages

```{r}
pacman::p_load('tidyverse', 
               'sf', 
               'here',
               'janitor',
               'tmap', 
               'kableExtra',
               'patchwork',
               'ggthemes',
               'colorRamps',
               'stars',
               'terra',
               'basemaps',
               'maptiles')
```

In this project I am working with multiple datasets that may have different crs's. I am going to be using a function to check the crs's matching

```{r}

```

## Data import

### Surface temperature
```{r}
sst_2008 <- rast(here('data',
                      'average_annual_sst_2008.tif')) 

sst_2009 <- rast(here('data',
                      'average_annual_sst_2009.tif'))
sst_2010 <- rast(here('data',
                      'average_annual_sst_2010.tif'))
sst_2011 <- rast(here('data',
                      'average_annual_sst_2011.tif'))
sst_2012 <- rast(here('data',
                      'average_annual_sst_2012.tif'))
```

### Bathymetry 

```{r}
bathy <- rast(here('data','depth.tif')) %>% 
  project("EPSG:4326")
```

### Exclusive Economic Zones
```{r}
eez <- st_read(here('data',
                    'wc_regions_clean.shp'), quiet = TRUE) %>% 
  st_transform("EPSG:4326")
        
```

### West coast shapefile
```{r}
coastline <- st_read(here('data',
                    'tl_2019_us_coastline', 
                    'tl_2019_us_coastline.shp'), quiet = TRUE)%>% 
  st_transform("EPSG:4326")
```

## Surface temperature mean 
```{r}
# Stacked raster
stacked_sst <- c(sst_2008, sst_2009, sst_2010, sst_2011, sst_2012) %>% 
  project("EPSG:4326")

# Take mean of stacked raster and transfer from celcius to kelvin
mean_sst <- mean(stacked_sst) - 273.15
```

## Bathymetry 
```{r}
# First we need to assure this data is in the same crs as sst
depth_projected <- project(bathy, mean_sst)

crs(depth_projected) == crs(mean_sst)

# We are going to crop the depth raster to the eez
depth_cropped <- crop(depth_projected, mean_sst)

# And resample to make sure our pixel sizes match 
depth_resampled <- resample(depth_projected, mean_sst)
```

## Oyster Reclassification 

We need to reclassify for oysters, which enjoy depth between -70 meters and 0 meters and temperatures between 11 and 30 degrees celcius 
```{r}
rcl_depth <- matrix(c(-Inf, -70, 0,
                    -70, 0, 1,
                    0, Inf, 0), 
                    nrow = 3, 
                    byrow = TRUE)

rcl_temp <- matrix(c(-Inf, 11, 0,
                     11, 30, 1,
                     30, Inf, 0), 
                   nrow =3,
                   byrow = TRUE)

depth_rcl <- classify(depth_resampled, rcl_depth)

sst_rcl <- classify(mean_sst, rcl_temp)
```

We want to keep where both sst and depth equal one, so we can multiply the two rasters. 

```{r}
suitable_cells <- sst_rcl * depth_rcl

suitable_cells[suitable_cells == 0] <- NA

names(suitable_cells) <- 'Suitable'
```

```{r}
extracted <- terra::extract(suitable_cells, eez, touches = TRUE)

extracted_counts <- extracted %>% 
  group_by(ID) %>% 
  summarise(count = sum(Suitable, na.rm = TRUE))

area_raster <- suitable_cells * cellSize(suitable_cells, unit = 'km')

```

```{r}
# Extract suitable areas area
area_extracted <- terra::extract(area_raster, 
                                 eez, 
                                 touches = TRUE) %>%  
  group_by(ID) %>% 
  summarise(suitable_area = sum(Suitable, na.rm = TRUE)) %>% 
  mutate(rgn = eez$rgn)

```


```{r}
region_suitable_area <- left_join(x = eez,
                                  y = area_extracted, 
                                  by = "rgn") %>% 
  select(-ID)
```

```{r}
ei_tiles = get_tiles(eez, provider = 'OpenStreetMap', crop = TRUE)


tm_basemap('OpenStreetMap')
tm_shape(region_suitable_area)+
  tm_polygons(fill = 'suitable_area',
              fill.scale = tm_scale(values = c('#E1DABD',
                                              '#ABC798',
                                              '#FFC4EB',
                                              '#E6983F',
                                              '#A0185A')),
              fill.legend = tm_legend( 'Suitable area'))


```


```{r}
references: 

https://wildlife.ca.gov/Conservation/Marine/Kelp 0-40 m 

https://pubmed.ncbi.nlm.nih.gov/37497792/ 10-18 degrees c
